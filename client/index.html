<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>VOID PRO ULTIMATE</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
    
    <style>
        :root { --void: #a020f0; --bg: #0d0d0f; --panel: #16161a; --text: #eee; --radius: 18px; }
        body.light-mode { --bg: #f8f9fa; --panel: #ffffff; --text: #212529; }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Pretendard', sans-serif; }
        body { background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* Î†àÏù¥ÏïÑÏõÉ */
        #sidebar { width: 280px; background: var(--panel); border-right: 1px solid rgba(255,255,255,0.05); display:flex; flex-direction:column; }
        #chat-window { flex: 1; display: flex; flex-direction: column; }
        header { padding: 18px 25px; background: var(--panel); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); }

        /* Ï±ÑÌåÖ Î¶¨Ïä§Ìä∏ (Î¨¥Ï°∞Í±¥ ÏôºÏ™Ω Ï†ïÎ†¨) */
        #messages { flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 18px; }
        .msg-row { 
            display: flex; gap: 12px; align-items: flex-start; max-width: 85%; 
            animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; 
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .avatar { width: 42px; height: 42px; border-radius: 50%; border: 2px solid #333; flex-shrink: 0; }
        .bubble-wrap { display: flex; flex-direction: column; gap: 4px; }
        .sender-name { font-size: 0.8rem; font-weight: 700; color: #888; }
        .bubble { padding: 12px 18px; border-radius: 0 var(--radius) var(--radius) var(--radius); background: #222; border: 1px solid rgba(255,255,255,0.05); line-height: 1.5; font-size: 0.95rem; word-break: break-all; }

        /* ÎÇ¥ Î©îÏãúÏßÄ (ÏôºÏ™Ω Ï†ïÎ†¨ Ïú†ÏßÄ + Î≥¥ÎùºÏÉâ) */
        .is-mine .bubble { background: var(--void); color: white; border: none; box-shadow: 0 4px 15px rgba(160, 32, 240, 0.2); }
        .is-mine .avatar { border-color: var(--void); }

        .msg-meta { display: flex; align-items: center; gap: 10px; font-size: 0.7rem; color: #666; margin-top: 4px; }
        .del-btn { color: #ff4d4d; cursor: pointer; visibility: hidden; }
        .msg-row:hover .del-btn { visibility: visible; }

        /* Í≥†Ï†ï ÏòÅÏó≠ */
        #typing-indicator { height: 25px; padding-left: 79px; font-size: 0.8rem; color: var(--void); font-style: italic; }
        #input-area { padding: 20px 25px; background: var(--panel); display: flex; gap: 12px; border-top: 1px solid rgba(255,255,255,0.05); }
        input { flex:1; padding: 14px; border-radius: 12px; border: 1px solid #333; background: rgba(0,0,0,0.2); color: #fff; outline: none; }
        .btn { border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; }

        /* ÌÜµÌôî UI */
        #call-ui { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:9999; }
        video { width: 45%; border-radius: 15px; border: 2px solid var(--void); }
    </style>
</head>
<body>

<nav id="sidebar">
    <div style="padding:30px; font-weight:900; font-size:1.4rem; color:var(--void);">VOID PRO</div>
    <div id="room-list"></div>
</nav>

<div id="chat-window">
    <header>
        <h3 id="room-title"># GLOBAL_LOBBY</h3>
        <div style="display:flex; gap:10px;">
            <button class="btn" style="background:#2ecc71; color:white;" onclick="startCall()">üìû CALL</button>
            <button class="btn" onclick="document.body.classList.toggle('light-mode')" style="background:#333; color:white;">üåó</button>
            <button class="btn" style="background:var(--void); color:white;" onclick="handleAuth()" id="auth-btn">LOGIN</button>
        </div>
    </header>
    <div id="messages"></div>
    <div id="typing-indicator"></div>
    <div id="input-area">
        <input type="text" id="msg-input" placeholder="Î©îÏãúÏßÄ ÏûÖÎ†•..." oninput="sendTyping()" onkeypress="if(event.key==='Enter') send()">
        <button class="btn" style="background:var(--void); color:white;" onclick="send()">SEND</button>
    </div>
</div>

<div id="call-ui">
    <div style="display:flex; gap:20px; width:90%; justify-content:center;">
        <video id="remote-v" autoplay playsinline></video>
        <video id="local-v" autoplay muted playsinline style="width:200px;"></video>
    </div>
    <button class="btn" style="background:#ff4d4d; margin-top:30px;" onclick="location.reload()">EXIT</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

    const config = {
        apiKey: "AIzaSyBA5UpytVU_dfQI4pMJ7A-pr4LN4jfU7lo",
        authDomain: "vn-gaming-messenger.firebaseapp.com",
        projectId: "vn-gaming-messenger",
        storageBucket: "vn-gaming-messenger.firebasestorage.app",
        messagingSenderId: "561627453007",
        appId: "1:561627453007:web:71e824bc094a132ea97c3a"
    };

    const app = initializeApp(config);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const socket = io(); // Ï†ëÏÜçÌïòÏûêÎßàÏûê Ïó∞Í≤∞
    const peer = new Peer();

    let my = { name: 'Guest_' + Math.floor(Math.random()*1000), pic: 'https://api.dicebear.com/7.x/bottts/svg?seed=void', pId: '' };
    let tTimer;

    // Ï¥àÍ∏∞ Ïù∏Ï¶ù ÏãúÎèÑ ÏóÜÏù¥ Î∞îÎ°ú ÏÜåÏºìÏóê Î≥∏Ïù∏ Ï†ïÎ≥¥ ÏïåÎ¶º
    peer.on('open', id => { 
        my.pId = id; 
        socket.emit('auth', my); 
    });

    // [Ïù∏Ï¶ù]
    window.handleAuth = () => auth.currentUser ? signOut(auth).then(()=>location.reload()) : signInWithPopup(auth, provider);
    onAuthStateChanged(auth, u => {
        if(u) {
            my.name = u.displayName; my.pic = u.photoURL;
            socket.emit('auth', my);
            document.getElementById('auth-btn').innerText = 'LOGOUT';
        }
    });

    // [Ï†ÑÌôî]
    window.startCall = () => {
        if(!confirm("ÌÜµÌôîÎ•º ÏãúÏûëÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) return;
        document.getElementById('call-ui').style.display = 'flex';
        navigator.mediaDevices.getUserMedia({video:true, audio:true}).then(s => {
            document.getElementById('local-v').srcObject = s;
            socket.emit('call-request', { peerId: my.pId });
        });
    };
    socket.on('incoming-call', d => {
        if(confirm("ÌÜµÌôî ÏöîÏ≤≠Ïù¥ ÏôîÏäµÎãàÎã§!")) {
            document.getElementById('call-ui').style.display = 'flex';
            navigator.mediaDevices.getUserMedia({video:true, audio:true}).then(s => {
                document.getElementById('local-v').srcObject = s;
                const call = peer.call(d.peerId, s);
                call.on('stream', rs => document.getElementById('remote-v').srcObject = rs);
            });
        }
    });
    peer.on('call', c => {
        navigator.mediaDevices.getUserMedia({video:true, audio:true}).then(s => {
            c.answer(s);
            c.on('stream', rs => document.getElementById('remote-v').srcObject = rs);
        });
    });

    // [Ï±ÑÌåÖ]
    window.send = () => {
        const input = document.getElementById('msg-input');
        if(!input.value.trim()) return;
        socket.emit('message', { msg: input.value });
        input.value = '';
        socket.emit('typing', false);
    };
    window.sendTyping = () => {
        socket.emit('typing', true);
        clearTimeout(tTimer);
        tTimer = setTimeout(() => socket.emit('typing', false), 2000);
    };
    window.askDel = (id) => { if(confirm("ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) socket.emit('delete-msg', id); };

    socket.on('message', d => {
        const isMe = d.senderId === socket.id;
        const msgDiv = document.createElement('div');
        msgDiv.className = `msg-row ${isMe ? 'is-mine' : ''}`;
        msgDiv.id = d.id;
        msgDiv.innerHTML = `
            <img src="${d.pic}" class="avatar">
            <div class="bubble-wrap">
                <div class="sender-name">${d.name}</div>
                <div class="bubble">${d.msg}</div>
                <div class="msg-meta">
                    <span style="color:var(--void); font-weight:bold;">1</span>
                    <span>${d.timestamp}</span>
                    ${isMe ? `<span class="del-btn" onclick="askDel('${d.id}')">ÏÇ≠Ï†ú</span>` : ''}
                </div>
            </div>
        `;
        document.getElementById('messages').appendChild(msgDiv);
        document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    });

    socket.on('msg-deleted', id => document.getElementById(id)?.remove());
    socket.on('display-typing', d => {
        document.getElementById('typing-indicator').innerText = d.isTyping ? `${d.name}ÎãòÏù¥ ÏûÖÎ†• Ï§ë...` : '';
    });
    socket.on('init-info', d => {
        document.getElementById('room-list').innerHTML = d.rooms.map(r => `
            <div style="padding:15px 25px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,0.05);" onclick="socket.emit('join-room','${r}'); document.getElementById('room-title').innerText='# '+r;"># ${r}</div>
        `).join('');
    });
</script>
</body>
</html>