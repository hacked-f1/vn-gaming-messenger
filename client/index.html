<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>VOID PREMIUM MESSENGER</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
    <style>
        :root { 
            --void: #a020f0; --void-dark: #7b1fa2; --bg: #0d0d0f; --panel: #16161a; 
            --text: #eee; --radius: 18px; --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        body.light-mode { --bg: #f5f7fb; --panel: #ffffff; --text: #1c1e21; }

        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Pretendard', sans-serif; }
        body { background: var(--bg); color: var(--text); display: flex; height: 100vh; transition: background 0.5s ease; }

        /* ì‚¬ì´ë“œë°” */
        #sidebar { width: 280px; background: var(--panel); border-right: 1px solid rgba(255,255,255,0.05); display:flex; flex-direction:column; }
        
        /* ì±„íŒ…ì°½ ë ˆì´ì•„ì›ƒ */
        #chat-window { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        header { padding: 20px 25px; background: var(--panel); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); z-index: 10; }

        /* ë©”ì‹œì§€ ì• ë‹ˆë©”ì´ì…˜ ë° ì •ë ¬ */
        #messages { flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        .msg-row { display: flex; gap: 12px; align-items: flex-start; max-width: 80%; animation: popIn 0.4s var(--transition) forwards; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        .avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #333; object-fit: cover; }
        .bubble-wrap { display: flex; flex-direction: column; gap: 5px; }
        .sender-name { font-size: 0.8rem; font-weight: 700; color: #888; }
        
        /* ë§í’ì„  ê¸°ë³¸: ì™¼ìª½ ì •ë ¬ */
        .bubble { 
            padding: 12px 18px; border-radius: 0 var(--radius) var(--radius) var(--radius); 
            background: var(--panel); border: 1px solid rgba(255,255,255,0.1); line-height: 1.6; 
            position: relative; transition: var(--transition);
        }

        /* ë‚´ ë©”ì‹œì§€ ê°•ì¡° */
        .is-mine .bubble { background: var(--void); color: white; border: none; box-shadow: 0 4px 15px rgba(160, 32, 240, 0.3); }
        .is-mine .avatar { border-color: var(--void); }

        /* ë©”ì‹œì§€ ì‚­ì œ/ì‹œê°„ ì •ë³´ */
        .msg-footer { display: flex; align-items: center; gap: 8px; font-size: 0.7rem; color: #555; margin-top: 4px; }
        .read-count { color: var(--void); font-weight: 800; }
        .del-btn { color: #ff5252; cursor: pointer; opacity: 0; transition: 0.3s; }
        .msg-row:hover .del-btn { opacity: 1; }

        /* ì…ë ¥ ì¤‘ ê³ ì • í‘œì‹œ */
        #typing-area { height: 25px; padding-left: 77px; font-size: 0.8rem; color: var(--void); font-style: italic; font-weight: 600; }

        /* ì…ë ¥ ë„êµ¬ */
        #input-panel { padding: 25px; background: var(--panel); display: flex; gap: 15px; align-items: center; }
        #msg-input { flex: 1; padding: 15px 20px; border-radius: 12px; border: 1px solid #333; background: rgba(0,0,0,0.3); color: #fff; outline: none; transition: 0.3s; }
        #msg-input:focus { border-color: var(--void); }
        .btn { border: none; padding: 12px 22px; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-void { background: var(--void); color: white; }
        .btn-call { background: #2ecc71; color: white; }
        
        /* ì˜ìƒí†µí™” í™”ë©´ */
        #call-ui { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:9999; }
        .v-grid { display: flex; gap: 20px; width: 80%; }
        video { width: 50%; border-radius: 15px; background: #000; border: 2px solid var(--void); }
    </style>
</head>
<body>

    <nav id="sidebar">
        <div style="padding:30px; font-size:1.5rem; font-weight:900; color:var(--void);">VOID PRO</div>
        <div id="rooms" style="flex:1;"></div>
    </nav>

    <main id="chat-window">
        <header>
            <h2 id="room-name"># LOBBY</h2>
            <div style="display:flex; gap:10px;">
                <select id="lang" onchange="applyLang()" style="background:#222; color:#fff; border:none; padding:5px 10px; border-radius:5px;">
                    <option value="ko">KO</option><option value="en">EN</option><option value="vi">VI</option>
                </select>
                <button class="btn btn-call" onclick="makeCall()">ğŸ“ CALL</button>
                <button class="btn" onclick="toggleTheme()" style="background:#333; color:#fff;">ğŸŒ—</button>
                <button class="btn btn-void" onclick="auth()" id="auth-btn">LOGIN</button>
            </div>
        </header>

        <div id="messages"></div>
        <div id="typing-area"></div>

        <div id="input-panel">
            <input type="text" id="msg-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." oninput="isTyping()" onkeypress="if(event.key==='Enter') send()">
            <button class="btn btn-void" onclick="send()" id="send-txt">ì „ì†¡</button>
        </div>
    </main>

    <div id="call-ui">
        <div class="v-grid">
            <video id="remote-v" autoplay playsinline></video>
            <video id="local-v" autoplay muted playsinline style="width:200px;"></video>
        </div>
        <button class="btn" style="background:#ff5252; margin-top:30px;" onclick="location.reload()">END CALL</button>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBA5UpytVU_dfQI4pMJ7A-pr4LN4jfU7lo",
        authDomain: "vn-gaming-messenger.firebaseapp.com",
        projectId: "vn-gaming-messenger",
        storageBucket: "vn-gaming-messenger.firebasestorage.app",
        messagingSenderId: "561627453007",
        appId: "1:561627453007:web:71e824bc094a132ea97c3a"
    };

    const fb = initializeApp(firebaseConfig);
    const authObj = getAuth(fb);
    const provider = new GoogleAuthProvider();
    const socket = io();
    const peer = new Peer();

    let my = { name: 'Guest', pic: 'https://api.dicebear.com/7.x/bottts/svg?seed=1', peerId: '' };
    let tTimer;

    peer.on('open', id => my.peerId = id);

    // [ì „í™” ê¸°ëŠ¥ ë³µêµ¬]
    window.makeCall = () => {
        document.getElementById('call-ui').style.display = 'flex';
        navigator.mediaDevices.getUserMedia({video:true, audio:true}).then(s => {
            document.getElementById('local-v').srcObject = s;
            socket.emit('call-request', { peerId: my.peerId });
        });
    };

    socket.on('incoming-call', d => {
        if(confirm("ì˜ìƒí†µí™” ìš”ì²­ì´ ì™”ìŠµë‹ˆë‹¤. ë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            document.getElementById('call-ui').style.display = 'flex';
            navigator.mediaDevices.getUserMedia({video:true, audio:true}).then(s => {
                document.getElementById('local-v').srcObject = s;
                const call = peer.call(d.peerId, s);
                call.on('stream', rs => document.getElementById('remote-v').srcObject = rs);
            });
        }
    });

    peer.on('call', call => {
        navigator.mediaDevices.getUserMedia({video:true, audio:true}).then(s => {
            call.answer(s);
            call.on('stream', rs => document.getElementById('remote-v').srcObject = rs);
        });
    });

    // [ë¡œê·¸ì¸ ë° í…Œë§ˆ]
    window.auth = () => authObj.currentUser ? signOut(authObj).then(()=>location.reload()) : signInWithPopup(authObj, provider);
    window.toggleTheme = () => document.body.classList.toggle('light-mode');
    
    onAuthStateChanged(authObj, u => {
        if(u) {
            my.name = u.displayName; my.pic = u.photoURL;
            socket.emit('auth', my);
            document.getElementById('auth-btn').innerText = 'LOGOUT';
        }
    });

    // [ë©”ì‹œì§€ ì „ì†¡ ë° ì‚­ì œ]
    window.send = () => {
        const el = document.getElementById('msg-input');
        if(!el.value.trim()) return;
        socket.emit('message', { msg: el.value });
        el.value = '';
        socket.emit('typing', false);
    };

    window.isTyping = () => {
        socket.emit('typing', true);
        clearTimeout(tTimer);
        tTimer = setTimeout(() => socket.emit('typing', false), 2000);
    };

    window.delMsg = (id) => socket.emit('delete-msg', id);

    socket.on('message', d => render(d));
    socket.on('msg-deleted', id => document.getElementById(id)?.remove());
    socket.on('display-typing', d => {
        document.getElementById('typing-area').innerText = d.isTyping ? `${d.name}ë‹˜ì´ ì…ë ¥ ì¤‘...` : '';
    });

    function render(d) {
        const isMe = d.senderId === socket.id;
        const area = document.getElementById('messages');
        const div = document.createElement('div');
        div.className = `msg-row ${isMe ? 'is-mine' : ''}`;
        div.id = d.id;
        div.innerHTML = `
            <img src="${d.pic || my.pic}" class="avatar">
            <div class="bubble-wrap">
                <div class="sender-name">${d.name}</div>
                <div class="bubble">${d.msg}</div>
                <div class="msg-footer">
                    <span class="read-count">1</span>
                    <span>${d.timestamp}</span>
                    ${isMe ? `<span class="del-btn" onclick="delMsg('${d.id}')">ì‚­ì œ</span>` : ''}
                </div>
            </div>
        `;
        area.appendChild(div);
        area.scrollTop = area.scrollHeight;
    }

    // [ë°© ê´€ë¦¬]
    socket.on('init-info', d => {
        document.getElementById('rooms').innerHTML = d.rooms.map(r => `<div style="padding:15px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,0.05);" onclick="socket.emit('join-room','${r}')"># ${r}</div>`).join('');
    });
</script>
</body>
</html>