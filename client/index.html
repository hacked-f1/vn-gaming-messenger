<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VOID PREMIUM MESSENGER</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --void: #a020f0; --light: #00aff4; --bg: #0d0d0f; --panel: #16161a; --radius: 15px; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Pretendard', sans-serif; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        body { background: var(--bg); color: #eee; display: flex; height: 100vh; overflow: hidden; }
        body.light-theme { --bg: #f4f7fa; --panel: #ffffff; color: #222; }

        /* ì¢Œì¸¡ ì‚¬ì´ë“œë°” */
        #sidebar { width: 280px; background: var(--panel); border-right: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; }
        .sidebar-header { padding: 25px; font-weight: 900; font-size: 1.2rem; color: var(--void); border-bottom: 1px solid rgba(255,255,255,0.05); }
        .nav-list { flex: 1; padding: 15px; overflow-y: auto; }
        .nav-item { padding: 12px 15px; border-radius: 10px; cursor: pointer; margin-bottom: 5px; opacity: 0.6; }
        .nav-item:hover, .nav-item.active { background: rgba(160, 32, 240, 0.1); opacity: 1; color: var(--void); }

        /* ë©”ì¸ ì±„íŒ…ì°½ */
        #chat-main { flex: 1; display: flex; flex-direction: column; }
        #chat-header { padding: 15px 25px; background: var(--panel); display: flex; justify-content: space-between; align-items: center; }
        #messages { flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 15px; background: rgba(0,0,0,0.1); }
        
        /* ë©”ì‹œì§€ ì• ë‹ˆë©”ì´ì…˜ */
        .msg-box { display: flex; gap: 12px; align-self: flex-start; max-width: 80%; animation: pop 0.3s ease; }
        @keyframes pop { from { opacity:0; transform:scale(0.9) translateY(10px); } to { opacity:1; transform:scale(1) translateY(0); } }
        .bubble { background: var(--panel); padding: 12px 16px; border-radius: 0 var(--radius) var(--radius) var(--radius); border: 1px solid rgba(255,255,255,0.03); }
        .mine { align-self: flex-end; flex-direction: row-reverse; }
        .mine .bubble { background: var(--void); color: white; border-radius: var(--radius) 0 var(--radius) var(--radius); }

        /* ì…ë ¥ì°½ */
        #input-area { padding: 20px; background: var(--panel); display: flex; gap: 10px; align-items: center; }
        input[type="text"] { flex: 1; padding: 15px; border-radius: 12px; border: 1px solid #333; background: #000; color: #fff; outline: none; }
        .btn { padding: 12px 20px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
        .btn-send { background: var(--void); color: #fff; }

        /* ì˜ìƒí†µí™” íŒì—… */
        #call-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 600px; background: #000; border-radius: 20px; padding: 20px; display: none; z-index: 100; border: 2px solid var(--void); }
        video { width: 100%; border-radius: 15px; background: #222; margin-bottom: 10px; }

        /* ë‹¤êµ­ì–´ ì„ íƒ */
        #lang-select { background: #222; color: #fff; border: none; padding: 5px; border-radius: 5px; }
        #typing-indicator { font-size: 0.8rem; color: var(--void); height: 20px; padding-left: 25px; }
    </style>
</head>
<body>

    <nav id="sidebar">
        <div class="sidebar-header">VOID MESSENGER</div>
        <div class="nav-list" id="room-list"></div>
        <div style="padding: 20px;">
            <button onclick="createNewRoom()" style="width:100%;" class="btn">+ New Server</button>
        </div>
    </nav>

    <main id="chat-main">
        <header id="chat-header">
            <div style="display: flex; align-items: center; gap: 10px;">
                <img id="my-pic" src="" style="width:35px; height:35px; border-radius:50%; border:2px solid var(--void);">
                <span id="room-title"># GLOBAL_LOBBY</span>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
                <select id="lang-select" onchange="applyLang()">
                    <option value="ko">KR</option>
                    <option value="en">EN</option>
                    <option value="vi">VI</option>
                </select>
                <button onclick="startCall()" class="btn" style="background:green;">ğŸ“</button>
                <button onclick="document.body.classList.toggle('light-theme')" class="btn" style="background:#444;">ğŸŒ—</button>
                <button id="login-btn" onclick="handleLogin()" class="btn btn-send">LOGIN</button>
            </div>
        </header>

        <div id="messages"></div>
        <div id="typing-indicator"></div>

        <div id="input-area">
            <label style="font-size: 1.5rem; cursor: pointer;">ğŸ“<input type="file" id="file-input" hidden></label>
            <input type="text" id="msg-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="checkTyping(event)">
            <button onclick="sendMsg()" class="btn btn-send" id="send-txt">SEND</button>
        </div>
    </main>

    <aside id="online-users" style="width: 220px; background: var(--panel); border-left: 1px solid rgba(255,255,255,0.05); padding: 20px;">
        <h4 style="font-size: 0.8rem; opacity: 0.5; margin-bottom: 20px;">ONLINE USERS</h4>
        <div id="user-list"></div>
    </aside>

    <div id="call-modal">
        <video id="remote-video" autoplay></video>
        <video id="local-video" autoplay muted style="width: 150px; position: absolute; bottom: 30px; right: 30px; border: 2px solid white;"></video>
        <button onclick="endCall()" class="btn" style="background:red; width:100%;">HANG UP</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

        // Firebase ì„¤ì • (ë¯¼ì„ë‹˜ì˜ í”„ë¡œì íŠ¸ ì •ë³´)
        const firebaseConfig = {
            apiKey: "AIzaSyBA5UpytVU_dfQI4pMJ7A-pr4LN4jfU7lo",
            authDomain: "vn-gaming-messenger.firebaseapp.com",
            projectId: "vn-gaming-messenger",
            storageBucket: "vn-gaming-messenger.firebasestorage.app",
            messagingSenderId: "561627453007",
            appId: "1:561627453007:web:71e824bc094a132ea97c3a"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const socket = io();
        const peer = new Peer(); // ì˜ìƒí†µí™”ìš© ê³ ìœ  ID ìƒì„±

        let myData = { name: 'ìµëª…', pic: 'https://api.dicebear.com/7.x/avataaars/svg?seed=1', room: 'GLOBAL_LOBBY', peerId: null };
        let isTyping = false;
        let typingTimeout;

        // ë‹¤êµ­ì–´ ì„¤ì •
        const langPack = {
            ko: { send: "ì „ì†¡", placeholder: "ë©”ì‹œì§€ ì…ë ¥...", login: "ë¡œê·¸ì¸", logout: "ë¡œê·¸ì•„ì›ƒ" },
            en: { send: "Send", placeholder: "Type a message...", login: "Login", logout: "Logout" },
            vi: { send: "Gá»­i", placeholder: "Nháº­p tin nháº¯n...", login: "ÄÄƒng nháº­p", logout: "ÄÄƒng xuáº¥t" }
        };

        window.applyLang = () => {
            const l = document.getElementById('lang-select').value;
            document.getElementById('msg-input').placeholder = langPack[l].placeholder;
            document.getElementById('send-txt').innerText = langPack[l].send;
            document.getElementById('login-btn').innerText = auth.currentUser ? langPack[l].logout : langPack[l].login;
        };

        // PeerJS: ì˜ìƒí†µí™” ìˆ˜ì‹  ì²˜ë¦¬
        peer.on('open', (id) => { myData.peerId = id; });
        peer.on('call', (call) => {
            if(confirm("ì˜ìƒí†µí™” ìš”ì²­ì´ ì™”ìŠµë‹ˆë‹¤. ë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then((stream) => {
                    document.getElementById('call-modal').style.display = 'block';
                    document.getElementById('local-video').srcObject = stream;
                    call.answer(stream);
                    call.on('stream', (remoteStream) => {
                        document.getElementById('remote-video').srcObject = remoteStream;
                    });
                });
            }
        });

        // ë¡œê·¸ì¸ / ì¸ì¦
        window.handleLogin = () => {
            if(auth.currentUser) signOut(auth).then(() => location.reload());
            else signInWithPopup(auth, provider);
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                myData.name = user.displayName;
                myData.pic = user.photoURL;
                document.getElementById('my-pic').src = myData.pic;
                applyLang();
                socket.emit('auth', myData);
            }
        });

        // ì±„íŒ… ë° ì‹¤ì‹œê°„ ê¸°ëŠ¥
        window.sendMsg = () => {
            const input = document.getElementById('msg-input');
            if(input.value.trim()) {
                // E2EE ì•”í˜¸í™” (ê°„ë‹¨í•˜ê²Œ b64 ì²˜ë¦¬, ì‹¤ì œ ì„œë¹„ìŠ¤ì‹œ CryptoJS ê¶Œì¥)
                const encrypted = btoa(unescape(encodeURIComponent(input.value)));
                socket.emit('message', { msg: encrypted });
                input.value = '';
                stopTyping();
            }
        };

        window.checkTyping = (e) => {
            if(e.keyCode === 13) sendMsg();
            else {
                if(!isTyping) {
                    isTyping = true;
                    socket.emit('typing', true);
                }
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(stopTyping, 2000);
            }
        };

        function stopTyping() {
            isTyping = false;
            socket.emit('typing', false);
        }

        socket.on('message', renderMsg);
        socket.on('chat-history', (history) => {
            document.getElementById('messages').innerHTML = '';
            history.forEach(renderMsg);
        });

        function renderMsg(data) {
            const container = document.getElementById('messages');
            const isMine = data.name === myData.name;
            const div = document.createElement('div');
            div.className = `msg-box ${isMine ? 'mine' : ''}`;
            div.id = `msg-${data.id}`;
            
            // ë³µí˜¸í™”
            const decrypted = decodeURIComponent(escape(atob(data.msg)));

            div.innerHTML = `
                <img src="${data.pic}" style="width:35px; height:35px; border-radius:50%;">
                <div class="bubble">
                    <div style="font-size:0.7rem; opacity:0.5; margin-bottom:4px;">${data.name}</div>
                    ${data.file ? `<img src="${data.file}" style="max-width:100%; border-radius:10px;">` : ''}
                    <div>${decrypted}</div>
                    <div style="font-size:0.6rem; opacity:0.3; text-align:right; margin-top:4px;">${data.timestamp} âœ“</div>
                </div>
                ${isMine ? `<span onclick="deleteMsg('${data.id}')" style="cursor:pointer; font-size:0.7rem; color:red; align-self:center; margin:0 10px;">X</span>` : ''}
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        window.deleteMsg = (id) => socket.emit('delete-msg', id);
        socket.on('msg-deleted', (id) => document.getElementById(`msg-${id}`)?.remove());

        // ì…ë ¥ ì¤‘ í‘œì‹œ
        socket.on('user-typing', (data) => {
            document.getElementById('typing-indicator').innerText = data.isTyping ? `${data.name}ë‹˜ì´ ì…ë ¥ ì¤‘...` : '';
        });

        // ì„œë²„/ë°© ê´€ë¦¬
        socket.on('init-data', (data) => {
            const list = document.getElementById('room-list');
            list.innerHTML = data.servers.map(s => `<div class="nav-item ${s === myData.room ? 'active' : ''}" onclick="window.joinRoom('${s}')"># ${s}</div>`).join('');
        });

        window.joinRoom = (name) => {
            myData.room = name;
            document.getElementById('room-title').innerText = `# ${name}`;
            socket.emit('join-room', name);
            // UI ì—…ë°ì´íŠ¸ëŠ” init-dataì—ì„œ ì¬ì²˜ë¦¬ë˜ë„ë¡ ìœ ë„
        };

        socket.on('user-update', (users) => {
            document.getElementById('user-list').innerHTML = users.map(u => `
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                    <div style="width:10px; height:10px; border-radius:50%; background:green;"></div>
                    <img src="${u.pic}" style="width:25px; height:25px; border-radius:50%;">
                    <span style="font-size:0.8rem;">${u.name}</span>
                </div>
            `).join('');
        });

        // ì˜ìƒí†µí™” ì‹œì‘
        window.startCall = () => {
            const targetPeerId = prompt("í†µí™”í•  ìƒëŒ€ì˜ PeerIDë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ìœ ì €ë¥¼ ì„ íƒí•˜ì„¸ìš” (í…ŒìŠ¤íŠ¸ìš©)");
            if(targetPeerId) {
                navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then((stream) => {
                    document.getElementById('call-modal').style.display = 'block';
                    document.getElementById('local-video').srcObject = stream;
                    const call = peer.call(targetPeerId, stream);
                    call.on('stream', (remoteStream) => {
                        document.getElementById('remote-video').srcObject = remoteStream;
                    });
                });
            }
        };

        window.endCall = () => { location.reload(); };

        // íŒŒì¼ ì „ì†¡
        document.getElementById('file-input').onchange = (e) => {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = () => socket.emit('message', { msg: btoa('Sent a file'), file: reader.result, fileName: file.name });
            reader.readAsDataURL(file);
        };
    </script>
</body>
</html>