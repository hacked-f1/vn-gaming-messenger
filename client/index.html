<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>VOID ULTIMATE MESSENGER</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --void: #a020f0; --bg: #0d0d0f; --panel: #16161a; --text: #eee; --radius: 18px; }
        /* ë¼ì´íŠ¸ í…Œë§ˆ ì„¤ì • */
        body.light-mode { --bg: #f0f2f5; --panel: #ffffff; --text: #1c1e21; }
        body.light-mode .bubble { background: #e4e6eb; color: #050505; }
        body.light-mode #messages { background: #f0f2f5; }

        * { margin:0; padding:0; box-sizing:border-box; font-family:sans-serif; }
        body { background: var(--bg); color: var(--text); display: flex; height: 100vh; transition: 0.3s; }

        #sidebar { width: 260px; background: var(--panel); border-right: 1px solid #333; display:flex; flex-direction:column; }
        #chat-window { flex: 1; display: flex; flex-direction: column; background: var(--bg); }
        
        /* ì±„íŒ…ì°½ ì˜ì—­ */
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        
        /* ì…ë ¥ ì¤‘ ì•Œë¦¼ ì˜ì—­ (ë©”ì‹œì§€ì™€ ë¶„ë¦¬ë¨) */
        #typing-display { height: 25px; padding-left: 20px; color: var(--void); font-size: 0.8rem; font-style: italic; font-weight: bold; }

        /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .msg-row { display: flex; gap: 10px; margin-bottom: 5px; align-items: flex-start; }
        .is-mine { flex-direction: row-reverse; }
        .bubble { padding: 10px 15px; border-radius: var(--radius); background: #222; max-width: 60%; word-break: break-all; }
        .is-mine .bubble { background: var(--void); color: white; }
        
        .msg-info { font-size: 0.7rem; color: #888; margin-top: 3px; display: flex; gap: 5px; }
        .read-status { color: var(--void); font-weight: bold; }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        #input-panel { padding: 20px; background: var(--panel); display: flex; gap: 10px; align-items: center; }
        input { flex:1; padding: 12px; border-radius: 10px; border: 1px solid #444; background: #000; color: #fff; }
        .btn { padding: 10px 15px; border-radius: 8px; border:none; cursor:pointer; font-weight:bold; }
        .btn-void { background: var(--void); color: white; }
    </style>
</head>
<body>

    <nav id="sidebar">
        <div style="padding:20px; font-weight:bold; font-size:1.2rem; color:var(--void);">VOID PRO</div>
        <div id="room-list" style="flex:1;"></div>
    </nav>

    <main id="chat-window">
        <header style="padding:15px; background:var(--panel); display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333;">
            <h3 id="head-title"># LOBBY</h3>
            <div style="display:flex; gap:8px;">
                <select id="lang-select" onchange="updateLanguage()">
                    <option value="ko">í•œêµ­ì–´</option>
                    <option value="en">English</option>
                    <option value="vi">Tiáº¿ng Viá»‡t</option>
                </select>
                <button class="btn" onclick="toggleTheme()" id="theme-btn">ğŸŒ— Theme</button>
                <button class="btn btn-void" onclick="authAction()" id="auth-btn">LOGIN</button>
            </div>
        </header>

        <div id="messages"></div>
        <div id="typing-display"></div>

        <div id="input-panel">
            <input type="text" id="msg-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." oninput="emitTyping()" onkeypress="if(event.key==='Enter') sendMsg()">
            <button class="btn btn-void" onclick="sendMsg()" id="send-btn">ì „ì†¡</button>
        </div>
    </main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBA5UpytVU_dfQI4pMJ7A-pr4LN4jfU7lo",
        authDomain: "vn-gaming-messenger.firebaseapp.com",
        projectId: "vn-gaming-messenger",
        storageBucket: "vn-gaming-messenger.firebasestorage.app",
        messagingSenderId: "561627453007",
        appId: "1:561627453007:web:71e824bc094a132ea97c3a"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const socket = io();

    let myInfo = { name: 'Guest', pic: '' };
    let typingTimer;

    // [1] ë‹¤êµ­ì–´ ë°ì´í„°
    const i18n = {
        ko: { send: "ì „ì†¡", placeholder: "ë©”ì‹œì§€ ì…ë ¥...", login: "ë¡œê·¸ì¸", logout: "ë¡œê·¸ì•„ì›ƒ" },
        en: { send: "Send", placeholder: "Type a message...", login: "Login", logout: "Logout" },
        vi: { send: "Gá»­i", placeholder: "Nháº­p tin nháº¯n...", login: "ÄÄƒng nháº­p", logout: "ÄÄƒng xuáº¥t" }
    };

    window.updateLanguage = () => {
        const lang = document.getElementById('lang-select').value;
        document.getElementById('send-btn').innerText = i18n[lang].send;
        document.getElementById('msg-input').placeholder = i18n[lang].placeholder;
        document.getElementById('auth-btn').innerText = auth.currentUser ? i18n[lang].logout : i18n[lang].login;
    };

    // [2] í…Œë§ˆ í† ê¸€ í•¨ìˆ˜ (í™•ì‹¤í•˜ê²Œ ìˆ˜ì •)
    window.toggleTheme = () => {
        document.body.classList.toggle('light-mode');
        console.log("í…Œë§ˆ ë³€ê²½ë¨");
    };

    // [3] ì…ë ¥ ì¤‘ ìƒíƒœ ì „ì†¡
    window.emitTyping = () => {
        socket.emit('typing', true);
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => socket.emit('typing', false), 2000);
    };

    // [4] ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ
    window.authAction = () => {
        if(auth.currentUser) signOut(auth).then(()=>location.reload());
        else signInWithPopup(auth, provider);
    };

    onAuthStateChanged(auth, user => {
        if (user) {
            myInfo = { name: user.displayName, pic: user.photoURL };
            socket.emit('auth', myInfo);
            updateLanguage();
        }
    });

    // [5] ë©”ì‹œì§€ ì „ì†¡
    window.sendMsg = () => {
        const input = document.getElementById('msg-input');
        if(!input.value.trim()) return;
        socket.emit('message', { msg: input.value });
        input.value = '';
        socket.emit('typing', false);
    };

    // [6] ì‹¤ì‹œê°„ ìˆ˜ì‹  ë¡œì§
    socket.on('message', data => {
        const isMine = data.senderId === socket.id;
        const msgArea = document.getElementById('messages');
        const div = document.createElement('div');
        div.className = `msg-row ${isMine ? 'is-mine' : ''}`;
        div.innerHTML = `
            <div class="bubble">${data.msg}</div>
            <div class="msg-info">
                <span class="read-status">1</span> 
                <span>${data.timestamp}</span>
            </div>
        `;
        msgArea.appendChild(div);
        msgArea.scrollTop = msgArea.scrollHeight;
    });

    // ì…ë ¥ ì¤‘ ìˆ˜ì‹  (ì±„íŒ…ì°½ ì•ˆì˜¬ë¼ì˜¤ê²Œ ë¶„ë¦¬ëœ ê³µê°„ì— í‘œì‹œ)
    socket.on('display-typing', data => {
        const display = document.getElementById('typing-display');
        display.innerText = data.isTyping ? `${data.name}ë‹˜ì´ ì…ë ¥ ì¤‘...` : '';
    });

    socket.on('init-info', data => {
        const list = document.getElementById('room-list');
        list.innerHTML = data.rooms.map(r => `<div style="padding:15px; cursor:pointer; border-bottom:1px solid #333;" onclick="socket.emit('join-room', '${r}')"># ${r}</div>`).join('');
    });
</script>
</body>
</html>