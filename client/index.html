<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>VOID PREMIUM MESSENGER</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
    <style>
        :root { 
            --void: #a020f0; --bg: #0d0d0f; --panel: #16161a; --text: #eee; 
            --radius: 18px; --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        body.light-mode { --bg: #f8f9fa; --panel: #ffffff; --text: #212529; }

        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Pretendard', sans-serif; }
        body { background: var(--bg); color: var(--text); display: flex; height: 100vh; transition: background 0.5s; }

        /* ì‚¬ì´ë“œë°” */
        #sidebar { width: 280px; background: var(--panel); border-right: 1px solid rgba(128,128,128,0.1); display:flex; flex-direction:column; }
        
        /* ë©”ì¸ ì±„íŒ… ì˜ì—­ */
        #chat-window { flex: 1; display: flex; flex-direction: column; position: relative; }
        header { padding: 18px 25px; background: var(--panel); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(128,128,128,0.1); }

        /* ì±„íŒ… ë©”ì‹œì§€ (ëª¨ë‘ ì™¼ìª½ ì •ë ¬ ìœ ì§€) */
        #messages { flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        .msg-row { 
            display: flex; gap: 12px; align-items: flex-start; max-width: 85%; 
            animation: slideUp 0.4s var(--transition) forwards; opacity: 0; 
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #333; object-fit: cover; }
        .bubble-wrap { display: flex; flex-direction: column; gap: 4px; }
        .sender-name { font-size: 0.75rem; font-weight: 700; color: #888; margin-left: 2px; }
        
        /* ë§í’ì„  ìŠ¤íƒ€ì¼ */
        .bubble { 
            padding: 12px 18px; border-radius: 0 var(--radius) var(--radius) var(--radius); 
            background: var(--panel); border: 1px solid rgba(128,128,128,0.1); 
            line-height: 1.6; font-size: 0.95rem; position: relative;
        }

        /* ë³¸ì¸ ë©”ì‹œì§€ ê°•ì¡° (ìŠ¤íƒ€ì¼ë§Œ ë³´ë¼ìƒ‰, ìœ„ì¹˜ëŠ” ì™¼ìª½ ìœ ì§€) */
        .is-mine .bubble { background: var(--void); color: white; border: none; box-shadow: 0 4px 15px rgba(160, 32, 240, 0.2); }
        .is-mine .avatar { border-color: var(--void); }

        /* í•˜ë‹¨ ë©”íƒ€ ì •ë³´ */
        .msg-meta { display: flex; align-items: center; gap: 8px; font-size: 0.65rem; color: #555; margin-top: 2px; }
        .read-status { color: var(--void); font-weight: 800; }
        .is-mine .read-status { color: #d199ff; }
        .del-btn { color: #ff4d4d; cursor: pointer; visibility: hidden; transition: 0.2s; }
        .msg-row:hover .del-btn { visibility: visible; }

        /* ì…ë ¥ ì¤‘ ê³ ì • í‘œì‹œ ì˜ì—­ */
        #typing-indicator { height: 25px; padding-left: 77px; font-size: 0.8rem; color: var(--void); font-style: italic; font-weight: 600; }

        /* ì…ë ¥ì°½ ì˜ì—­ */
        #input-area { padding: 20px 25px; background: var(--panel); display: flex; gap: 12px; align-items: center; border-top: 1px solid rgba(128,128,128,0.1); }
        input { 
            flex:1; padding: 14px 20px; border-radius: 12px; border: 1px solid #333; 
            background: rgba(0,0,0,0.2); color: var(--text); outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--void); }
        .btn { border: none; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-void { background: var(--void); color: white; }
        .btn-call { background: #2ecc71; color: white; }

        /* í†µí™” ë ˆì´ì–´ */
        #call-ui { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:9999; }
        video { width: 40%; border-radius: 15px; border: 2px solid var(--void); background: #000; }
    </style>
</head>
<body>

<nav id="sidebar">
    <div style="padding:30px 25px; font-weight:900; font-size:1.4rem; color:var(--void);">VOID PRO</div>
    <div id="room-list" style="flex:1;"></div>
</nav>

<div id="chat-window">
    <header>
        <h3 id="room-title"># LOBBY</h3>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-call" onclick="startCall()">ğŸ“ CALL</button>
            <button class="btn" onclick="toggleTheme()" style="background:#333; color:white;">ğŸŒ—</button>
            <button class="btn btn-void" onclick="handleAuth()" id="auth-btn">LOGIN</button>
        </div>
    </header>

    <div id="messages"></div>
    <div id="typing-indicator"></div>

    <div id="input-area">
        <input type="text" id="msg-input" placeholder="Enter message..." oninput="sendTyping()" onkeypress="if(event.key==='Enter') send()">
        <button class="btn btn-void" onclick="send()">SEND</button>
    </div>
</div>

<div id="call-ui">
    <div style="display:flex; gap:20px; width:90%; justify-content:center;">
        <video id="remote-v" autoplay playsinline></video>
        <video id="local-v" autoplay muted playsinline style="width:200px;"></video>
    </div>
    <button class="btn" style="background:#e74c3c; margin-top:30px; padding:15px 40px;" onclick="location.reload()">HANG UP</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

    const fbConfig = {
        apiKey: "AIzaSyBA5UpytVU_dfQI4pMJ7A-pr4LN4jfU7lo",
        authDomain: "vn-gaming-messenger.firebaseapp.com",
        projectId: "vn-gaming-messenger",
        storageBucket: "vn-gaming-messenger.firebasestorage.app",
        messagingSenderId: "561627453007",
        appId: "1:561627453007:web:71e824bc094a132ea97c3a"
    };

    const app = initializeApp(fbConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const socket = io();
    const peer = new Peer();

    let myData = { name: 'Guest', pic: 'https://api.dicebear.com/7.x/bottts/svg?seed=1', peerId: '' };
    let tTimer;

    peer.on('open', id => myData.peerId = id);

    // [ì „í™” ê¸°ëŠ¥]
    window.startCall = () => {
        if(!confirm("ì´ ë°© ì‚¬ëŒë“¤ì—ê²Œ ì „í™”ë¥¼ ê±°ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        document.getElementById('call-ui').style.display = 'flex';
        navigator.mediaDevices.getUserMedia({video:true, audio:true}).then(s => {
            document.getElementById('local-v').srcObject = s;
            socket.emit('call-request', { peerId: myData.peerId });
        });
    };

    socket.on('incoming-call', d => {
        if(confirm(`${d.fromName}ë‹˜ì˜ í†µí™” ìš”ì²­! ë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            document.getElementById('call-ui').style.display = 'flex';
            navigator.mediaDevices.getUserMedia({video:true, audio:true}).then(s => {
                document.getElementById('local-v').srcObject = s;
                const call = peer.call(d.peerId, s);
                call.on('stream', rs => document.getElementById('remote-v').srcObject = rs);
            });
        }
    });

    peer.on('call', call => {
        navigator.mediaDevices.getUserMedia({video:true, audio:true}).then(s => {
            call.answer(s);
            call.on('stream', rs => document.getElementById('remote-v').srcObject = rs);
        });
    });

    // [ì¸ì¦ ë° í…Œë§ˆ]
    window.handleAuth = () => auth.currentUser ? signOut(auth).then(()=>location.reload()) : signInWithPopup(auth, provider);
    window.toggleTheme = () => document.body.classList.toggle('light-mode');
    
    onAuthStateChanged(auth, u => {
        if(u) {
            myData.name = u.displayName; myData.pic = u.photoURL;
            socket.emit('auth', myData);
            document.getElementById('auth-btn').innerText = 'LOGOUT';
        }
    });

    // [ë©”ì‹œì§€ í•µì‹¬ ë¡œì§]
    window.send = () => {
        const input = document.getElementById('msg-input');
        if(!input.value.trim()) return;
        socket.emit('message', { msg: input.value });
        input.value = '';
        socket.emit('typing', false);
    };

    window.sendTyping = () => {
        socket.emit('typing', true);
        clearTimeout(tTimer);
        tTimer = setTimeout(() => socket.emit('typing', false), 2000);
    };

    window.confirmDelete = (id) => {
        if(confirm("ì •ë§ë¡œ ì´ ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) socket.emit('delete-msg', id);
    };

    socket.on('message', d => renderMsg(d));
    socket.on('msg-deleted', id => document.getElementById(id)?.remove());
    socket.on('display-typing', d => {
        document.getElementById('typing-indicator').innerText = d.isTyping ? `${d.name}ë‹˜ì´ ì…ë ¥ ì¤‘...` : '';
    });

    function renderMsg(d) {
        const isMe = d.senderId === socket.id;
        const msgList = document.getElementById('messages');
        const div = document.createElement('div');
        div.className = `msg-row ${isMe ? 'is-mine' : ''}`;
        div.id = d.id;
        div.innerHTML = `
            <img src="${d.pic}" class="avatar">
            <div class="bubble-wrap">
                <div class="sender-name">${d.name}</div>
                <div class="bubble">${d.msg}</div>
                <div class="msg-meta">
                    <span class="read-status">1</span>
                    <span>${d.timestamp}</span>
                    ${isMe ? `<span class="del-btn" onclick="confirmDelete('${d.id}')">ì‚­ì œ</span>` : ''}
                </div>
            </div>
        `;
        msgList.appendChild(div);
        msgList.scrollTop = msgList.scrollHeight;
    }

    socket.on('init-info', d => {
        document.getElementById('room-list').innerHTML = d.rooms.map(r => `<div style="padding:15px 25px; cursor:pointer; border-bottom:1px solid rgba(128,128,128,0.1);" onclick="socket.emit('join-room', '${r}')"># ${r}</div>`).join('');
    });
</script>
</body>
</html>