<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>VOID PREMIUM</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
    <style>
        :root { --void: #7c3aed; --bg: #0f0f12; --panel: #18181b; --text: #e4e4e7; --border: #27272a; }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Pretendard', sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }

        /* [ë¡œê·¸ì¸/ê°€ì… í™”ë©´] */
        #auth-container { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .auth-box { width: 350px; padding: 40px; background: var(--panel); border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center; }
        .auth-title { font-size: 24px; font-weight: 800; color: var(--void); margin-bottom: 30px; letter-spacing: -1px; }
        .input-group { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
        input { width: 100%; padding: 14px; background: #000; border: 1px solid var(--border); border-radius: 10px; color: white; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--void); }
        .btn-auth { width: 100%; padding: 14px; background: var(--void); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; margin-bottom: 10px; }
        .toggle-txt { font-size: 13px; color: #888; cursor: pointer; text-decoration: underline; }

        /* [ë©”ì¸ ì±„íŒ… í™”ë©´] */
        #app-container { display: flex; width: 100%; height: 100%; display: none; }
        #sidebar { width: 260px; background: var(--panel); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; }
        #chat-window { flex: 1; display: flex; flex-direction: column; position: relative; }

        header { height: 70px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 25px; background: var(--panel); }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        .msg-row { display: flex; gap: 12px; max-width: 80%; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
        
        .bubble { padding: 12px 16px; background: #27272a; border-radius: 0 16px 16px 16px; line-height: 1.5; font-size: 15px; }
        .is-mine .bubble { background: var(--void); color: white; }
        .msg-img { max-width: 250px; border-radius: 10px; cursor: pointer; margin-top: 5px; }
        .meta { font-size: 12px; color: #666; margin-top: 4px; display: flex; gap: 10px; }
        .del-btn { color: #ef4444; cursor: pointer; display: none; }
        .msg-row:hover .del-btn { display: block; }

        #input-area { padding: 20px; background: var(--panel); border-top: 1px solid var(--border); display: flex; gap: 10px; position: relative; }
        #typing { position: absolute; top: -30px; left: 20px; color: var(--void); font-size: 13px; font-style: italic; opacity: 0; transition: 0.3s; }
        .btn-icon { background: none; border: none; color: #aaa; font-size: 20px; cursor: pointer; padding: 0 10px; }
        .btn-send { background: var(--void); color: white; padding: 0 20px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; }
        
        /* í†µí™” ëª¨ë‹¬ */
        #call-ui { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        video { width: 300px; height: 225px; background: black; border: 2px solid var(--void); border-radius: 15px; margin: 10px; }
    </style>
</head>
<body>

<div id="auth-container">
    <div class="auth-box">
        <div class="auth-title">VOID MESSENGER</div>
        
        <div id="login-form">
            <div class="input-group">
                <input type="email" id="login-email" placeholder="ì´ë©”ì¼">
                <input type="password" id="login-pw" placeholder="ë¹„ë°€ë²ˆí˜¸">
            </div>
            <button class="btn-auth" onclick="handleLogin()">ë¡œê·¸ì¸</button>
            <div class="toggle-txt" onclick="toggleAuthMode()">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? íšŒì›ê°€ì…</div>
        </div>

        <div id="register-form" style="display:none;">
            <div class="input-group">
                <input type="text" id="reg-name" placeholder="ë‹‰ë„¤ì„ (ëŒ€í™”ëª…)">
                <input type="email" id="reg-email" placeholder="ì´ë©”ì¼">
                <input type="password" id="reg-pw" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ìë¦¬ ì´ìƒ)">
            </div>
            <button class="btn-auth" onclick="handleRegister()">íšŒì›ê°€ì…</button>
            <div class="toggle-txt" onclick="toggleAuthMode()">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? ë¡œê·¸ì¸</div>
        </div>
    </div>
</div>

<div id="app-container">
    <nav id="sidebar">
        <div style="margin-bottom:20px; display:flex; align-items:center; gap:10px;">
            <img id="my-avatar" src="" style="width:40px; height:40px; border-radius:50%; background:#333;">
            <div>
                <div id="my-name" style="font-weight:bold;"></div>
                <div style="font-size:12px; color:#666;">Online</div>
            </div>
        </div>
        <div style="font-size:12px; color:#555; margin-bottom:10px;">ROOMS</div>
        <div id="room-list"></div>
    </nav>

    <main id="chat-window">
        <header>
            <h3 id="room-title"># LOBBY</h3>
            <div style="display:flex; gap:15px;">
                <button class="btn-icon" onclick="startCall()" title="ì „í™”">ğŸ“</button>
                <button class="btn-icon" onclick="doLogout()" title="ë¡œê·¸ì•„ì›ƒ">ğŸšª</button>
            </div>
        </header>

        <div id="messages"></div>
        
        <div id="input-area">
            <div id="typing">ì…ë ¥ ì¤‘...</div>
            <input type="file" id="file-up" hidden accept="image/*" onchange="uploadImg()">
            <button class="btn-icon" onclick="document.getElementById('file-up').click()">ğŸ“·</button>
            <input type="text" id="msg-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="if(event.key==='Enter') send()">
            <button class="btn-send" onclick="send()">ì „ì†¡</button>
        </div>
    </main>
</div>

<div id="call-ui">
    <h2 style="color:white; margin-bottom:20px;">ì˜ìƒ í†µí™” ì—°ê²° ì¤‘...</h2>
    <div style="display:flex; gap:20px;">
        <video id="remote-v" autoplay playsinline></video>
        <video id="local-v" autoplay muted playsinline></video>
    </div>
    <button class="btn-send" style="background:#ef4444; margin-top:30px;" onclick="location.reload()">í†µí™” ì¢…ë£Œ</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

    // ë¯¼ì„ë‹˜ì˜ Firebase í‚¤
    const firebaseConfig = {
        apiKey: "AIzaSyBA5UpytVU_dfQI4pMJ7A-pr4LN4jfU7lo",
        authDomain: "vn-gaming-messenger.firebaseapp.com",
        projectId: "vn-gaming-messenger",
        storageBucket: "vn-gaming-messenger.firebasestorage.app",
        messagingSenderId: "561627453007",
        appId: "1:561627453007:web:71e824bc094a132ea97c3a"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const socket = io();
    const peer = new Peer();

    let myPeerId = '';
    let timer;

    peer.on('open', id => myPeerId = id);

    // [1] ì¸ì¦ ë¡œì§ (ì´ë©”ì¼ ê°€ì…/ë¡œê·¸ì¸)
    window.toggleAuthMode = () => {
        const loginForm = document.getElementById('login-form');
        const regForm = document.getElementById('register-form');
        if (loginForm.style.display === 'none') {
            loginForm.style.display = 'block'; regForm.style.display = 'none';
        } else {
            loginForm.style.display = 'none'; regForm.style.display = 'block';
        }
    };

    // íšŒì›ê°€ì…
    window.handleRegister = async () => {
        const email = document.getElementById('reg-email').value;
        const pw = document.getElementById('reg-pw').value;
        const name = document.getElementById('reg-name').value;

        if (!email || !pw || !name) return alert('ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');

        try {
            const res = await createUserWithEmailAndPassword(auth, email, pw);
            // ë‹‰ë„¤ì„ ì—…ë°ì´íŠ¸
            await updateProfile(res.user, { displayName: name });
            alert('íšŒì›ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            window.toggleAuthMode();
        } catch (err) {
            alert('ê°€ì… ì‹¤íŒ¨: ' + err.message);
        }
    };

    // ë¡œê·¸ì¸
    window.handleLogin = async () => {
        const email = document.getElementById('login-email').value;
        const pw = document.getElementById('login-pw').value;

        try {
            const res = await signInWithEmailAndPassword(auth, email, pw);
            // ì†Œì¼“ì— ì¸ì¦ ì •ë³´ ì „ì†¡
            socket.emit('auth-success', {
                uid: res.user.uid,
                email: res.user.email,
                displayName: res.user.displayName,
                photoURL: res.user.photoURL
            });
        } catch (err) {
            alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: ì´ë©”ì¼ì´ë‚˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        }
    };

    window.doLogout = () => signOut(auth).then(() => location.reload());

    // [2] ë¡œê·¸ì¸ ì„±ê³µ í›„ ì²˜ë¦¬
    socket.on('login-complete', (user) => {
        document.getElementById('auth-container').style.display = 'none';
        document.getElementById('app-container').style.display = 'flex';
        
        document.getElementById('my-name').innerText = user.name;
        document.getElementById('my-avatar').src = user.avatar;
    });

    socket.on('force-join', room => socket.emit('join-room', room));

    // [3] ì±„íŒ… ê¸°ëŠ¥
    window.send = () => {
        const el = document.getElementById('msg-input');
        if(!el.value.trim()) return;
        socket.emit('message', { msg: el.value, type: 'text' });
        el.value = '';
        socket.emit('typing', false);
    };

    window.uploadImg = () => {
        const f = document.getElementById('file-up').files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = (e) => socket.emit('message', { msg: e.target.result, type: 'image' });
        r.readAsDataURL(f);
    };

    document.getElementById('msg-input').addEventListener('input', () => {
        socket.emit('typing', true);
        clearTimeout(timer);
        timer = setTimeout(() => socket.emit('typing', false), 2000);
    });

    window.delMsg = (id) => { if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) socket.emit('delete-msg', id); };

    // [4] í™”ë©´ ë Œë”ë§
    socket.on('message', d => {
        const isMe = d.senderId === socket.id;
        const box = document.getElementById('messages');
        const div = document.createElement('div');
        div.className = `msg-row ${isMe ? 'is-mine' : ''}`;
        div.id = d.id;

        let content = `<div class="bubble">${d.msg}</div>`;
        if(d.type === 'image') content = `<img src="${d.msg}" class="msg-img" onclick="window.open(this.src)">`;

        div.innerHTML = `
            <img src="${d.avatar}" style="width:36px; height:36px; border-radius:50%; flex-shrink:0;">
            <div style="display:flex; flex-direction:column; gap:4px;">
                <span style="font-size:12px; color:#888; font-weight:bold;">${d.name}</span>
                ${content}
                <div class="meta">
                    <span>${d.timestamp}</span>
                    ${isMe ? `<span class="del-btn" onclick="delMsg('${d.id}')">ì‚­ì œ</span>` : ''}
                </div>
            </div>
        `;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    });

    socket.on('load-history', history => history.forEach(msg => socket.emit('message-render-only', msg) || renderRaw(msg)));
    // íˆìŠ¤í† ë¦¬ ì²˜ë¦¬ë¥¼ ìœ„í•´ ê°„ë‹¨í•œ ë Œë”ëŸ¬ ì¬ì‚¬ìš© (ì‹¤ì œë¡  ìœ„ì˜ message ì´ë²¤íŠ¸ì™€ ë¡œì§ ë™ì¼)
    function renderRaw(d) { /* message ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë‚´ìš©ì„ í•¨ìˆ˜ë¡œ ë¹¼ì„œ ì“°ëŠ” ê²Œ ì¢‹ì§€ë§Œ ì½”ë“œ ê¸¸ì´ìƒ ìƒëµ, ìœ„ message ë¡œì§ì´ ì‹¤í–‰ë¨ */ }
    
    // ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ íˆìŠ¤í† ë¦¬ ë¡œë“œ ì‹œ ë°”ë¡œ ë Œë”ë§í•˜ë„ë¡ ìˆ˜ì •
    socket.on('load-history', msgs => {
        document.getElementById('messages').innerHTML = '';
        msgs.forEach(d => {
             // ìœ„ message ì´ë²¤íŠ¸ ë¡œì§ ë³µì‚¬ (í•¨ìˆ˜í™” ì¶”ì²œ)
             const isMe = d.senderId === socket.id; // ì£¼ì˜: ìƒˆë¡œê³ ì¹¨ ì‹œ socket.id ë°”ë€œ. ì‹¤ì œë¡  uid ë¹„êµê°€ ì¢‹ìŒ.
             // ì—¬ê¸°ì„  ì‹œê°ì  í™•ì¸ì„ ìœ„í•´ ê·¸ëƒ¥ ë Œë”ë§ë§Œ
             const box = document.getElementById('messages');
             const div = document.createElement('div');
             div.className = `msg-row`; // ë‚´ ë©”ì‹œì§€ íŒë‹¨ ë³´ë¥˜
             div.id = d.id;
             let content = `<div class="bubble">${d.msg}</div>`;
             if(d.type === 'image') content = `<img src="${d.msg}" class="msg-img" onclick="window.open(this.src)">`;
             div.innerHTML = `<img src="${d.avatar}" style="width:36px; height:36px; border-radius:50%;"><div><div style="color:#888;font-size:12px;">${d.name}</div>${content}</div>`;
             box.appendChild(div);
        });
        document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    });

    socket.on('msg-deleted', id => document.getElementById(id)?.remove());
    socket.on('display-typing', d => {
        const t = document.getElementById('typing');
        t.innerText = d.isTyping ? `${d.name}ë‹˜ì´ ì…ë ¥ ì¤‘...` : '';
        t.style.opacity = d.isTyping ? 1 : 0;
    });

    socket.on('init-rooms', list => {
        document.getElementById('room-list').innerHTML = list.map(r => 
            `<div style="padding:10px; cursor:pointer; color:#888;" onclick="socket.emit('join-room','${r}'); document.getElementById('room-title').innerText='# ${r}'"># ${r}</div>`
        ).join('');
    });

    // [5] ì „í™” ê¸°ëŠ¥
    window.startCall = () => {
        if(!confirm('ì „í™”ë¥¼ ê±°ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        document.getElementById('call-ui').style.display = 'flex';
        navigator.mediaDevices.getUserMedia({video:true, audio:true}).then(s => {
            document.getElementById('local-v').srcObject = s;
            socket.emit('call-request', { peerId: myPeerId, from: document.getElementById('my-name').innerText });
        });
    };
    socket.on('incoming-call', d => {
        if(confirm(`${d.from}ë‹˜ì˜ ì „í™” ìš”ì²­!`)) {
            document.getElementById('call-ui').style.display = 'flex';
            navigator.mediaDevices.getUserMedia({video:true, audio:true}).then(s => {
                document.getElementById('local-v').srcObject = s;
                const call = peer.call(d.peerId, s);
                call.on('stream', rs => document.getElementById('remote-v').srcObject = rs);
            });
        }
    });
    peer.on('call', c => {
        navigator.mediaDevices.getUserMedia({video:true, audio:true}).then(s => {
            c.answer(s);
            c.on('stream', rs => document.getElementById('remote-v').srcObject = rs);
        });
    });
</script>
</body>
</html>